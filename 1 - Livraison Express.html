<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Livraison Express : V0.19 Chameleon</title>
    <style>
        :root {
            --primary: #2c3e50; --accent: #ff4757; --success: #2ed573;
            --warning: #ffa502; --info: #1e90ff; --purple: #a55eea;
            --dark: #121212; --panel: #1e1e1e; --border: #333; --xp: #ffd32a;
            --mythic: #ff6b81; --legend: #7efff5; --mil: #57606f;
        }
        body {
            font-family: 'Segoe UI', Roboto, Arial, sans-serif;
            background: var(--dark); margin: 0; padding: 0; color: #dfe4ea; 
            padding-bottom: 80px; overflow-x: hidden;
        }
        .container { max-width: 1400px; margin: 0 auto; padding: 20px; }
        
        /* HEADER */
        header { 
            background: var(--panel); border: 1px solid var(--border); padding: 15px 25px; 
            border-radius: 12px; margin-bottom: 20px; display: flex; justify-content: space-between; 
            align-items: center; position: relative; box-shadow: 0 4px 15px rgba(0,0,0,0.5);
        }
        .turbo-zone {
            position: absolute; bottom: 0; left: 50%; transform: translateX(-50%);
            width: 250px; height: 6px; background: #333; border-radius: 6px 6px 0 0;
            cursor: pointer; transition: 0.3s; z-index: 10;
        }
        .turbo-zone:hover { height: 35px; background: var(--accent); box-shadow: 0 0 20px var(--accent); }
        .clock-display { font-size: 2.2em; font-family: 'Courier New', monospace; font-weight: bold; color: #fff; text-shadow: 0 0 5px rgba(255,255,255,0.2); }
        
        /* STATS */
        .stats-bar {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 15px;
            background: var(--panel); padding: 15px; border-radius: 12px; border: 1px solid var(--border);
            margin-bottom: 20px;
        }
        .stat-item { text-align: center; }
        .stat-label { font-size: 0.75em; color: #888; text-transform: uppercase; letter-spacing: 1px; display: block; margin-bottom: 5px; }
        .stat-value { font-size: 1.1em; font-weight: bold; color: #fff; }

        /* GRID LAYOUT */
        .grid-container { display: grid; grid-template-columns: 2.2fr 1fr; gap: 25px; }
        @media (max-width: 1000px) { .grid-container { grid-template-columns: 1fr; } }
        
        .section { background: var(--panel); border: 1px solid var(--border); border-radius: 12px; padding: 20px; margin-bottom: 20px; position: relative; }
        h2 { margin-top: 0; border-bottom: 1px solid var(--border); padding-bottom: 10px; font-size: 1.1em; display: flex; justify-content: space-between; align-items: center; }
        
        /* MAP */
        #map-container {
            width: 100%; height: 500px; background: #000; border-radius: 8px; 
            border: 2px solid #333; position: relative; overflow: hidden;
            box-shadow: inset 0 0 50px rgba(0,0,0,0.8); transition: border-color 0.5s;
        }
        canvas { display: block; width: 100%; height: 100%; }

        /* CARDS */
        .card {
            background: #252525; border-left: 3px solid #555; padding: 12px; margin-bottom: 10px;
            border-radius: 6px; display: flex; justify-content: space-between; align-items: center;
            transition: 0.2s; position: relative; overflow: hidden;
        }
        .card-active { border-left-color: var(--success); background: #1b261b; }

        /* BUTTONS */
        button { cursor: pointer; border: none; border-radius: 6px; padding: 8px 12px; font-weight: bold; transition: 0.2s; color: white; font-size: 0.9em; }
        button:hover { filter: brightness(1.2); transform: translateY(-1px); }
        
        .btn-green { background: var(--success); color: #000; }
        .btn-red { background: var(--accent); }
        .btn-blue { background: var(--info); }
        .btn-purple { background: var(--purple); }
        .btn-xp { background: var(--xp); color: #000; }
        .btn-info { background: var(--info); }
        .settings-btn { background: #444; color: #fff; font-size: 1.2em; padding: 5px 10px; }

        .btn-fancy { 
            width: 100%; display: flex; justify-content: space-between; align-items: center;
            padding: 15px; margin-top: 10px; border-radius: 8px; text-align: left;
            border: 1px solid rgba(255,255,255,0.1);
        }
        .btn-fancy.xp { background: linear-gradient(45deg, #e1b12c, #cd6133); color: #dfe4ea; }
        .btn-fancy.shop { background: linear-gradient(45deg, #27ae60, #16a085); }
        .btn-fancy.hire { background: linear-gradient(45deg, #2980b9, #8e44ad); }
        .btn-fancy.info { background: linear-gradient(45deg, #1e90ff, #3498db); }
        .btn-fancy .icon { font-size: 1.5em; opacity: 0.8; }

        /* TABS & GRID ITEMS */
        .tabs-wrapper { margin-top: 10px; }
        .tabs-header { display: flex; gap: 5px; overflow-x: auto; padding-bottom: 5px; border-bottom: 1px solid #444; margin-bottom: 15px; }
        .tab-btn {
            background: #2a2a2a; border: none; color: #888; padding: 8px 15px; 
            border-radius: 8px 8px 0 0; cursor: pointer; font-weight: bold; transition: 0.2s; white-space: nowrap;
        }
        .tab-btn.active { background: var(--info); color: white; }
        
        .mission-grid-item {
            background: #252525; padding: 10px; border-radius: 6px; border: 1px solid #333; margin-bottom: 10px;
            display: flex; flex-direction: column; gap: 5px; cursor: pointer; transition: 0.2s;
        }
        .mission-grid-item:hover { border-color: var(--info); transform: translateY(-2px); }

        .badge { font-size: 0.7em; background: #333; padding: 2px 6px; border-radius: 4px; border: 1px solid #444; margin-right: 5px; }
        .badge-cap { color: var(--info); border-color: var(--info); }
        .badge-time { color: var(--warning); border-color: var(--warning); }

        /* MODALS */
        .modal { display: none; position: fixed; z-index: 9999; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); backdrop-filter: blur(4px); align-items: center; justify-content: center; }
        .modal-content { background: #1e1e1e; padding: 25px; border-radius: 16px; width: 900px; max-width: 95%; border: 1px solid #444; max-height: 90vh; overflow-y: auto; box-shadow: 0 0 50px rgba(0,0,0,0.8); }
        .shop-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(240px, 1fr)); gap: 15px; margin-top: 20px; }
        .shop-item { background: #2a2a2a; padding: 15px; border-radius: 10px; border: 1px solid #333; text-align: center; cursor: pointer; transition: 0.2s; position: relative; overflow: hidden; }
        .shop-item:hover { border-color: var(--accent); background: #333; transform: translateY(-3px); box-shadow: 0 5px 15px rgba(0,0,0,0.3); }
        .shop-item.mythic-item { border: 1px solid var(--mythic); background: rgba(255, 107, 129, 0.1); }
        .shop-item.legend-item { border: 1px solid var(--legend); background: rgba(126, 255, 245, 0.1); }
        .tag-price { position: absolute; top: 10px; right: 10px; background: var(--success); color: #000; padding: 3px 8px; border-radius: 4px; font-size: 0.85em; font-weight: bold; }
        .tag-owned { background: #555; color: #aaa; }

        /* STYLE PREVIEW CARDS */
        .style-card {
            padding: 15px; border-radius: 8px; border: 2px solid #444; cursor: pointer; text-align: center; transition: 0.2s;
        }
        .style-card:hover { transform: scale(1.05); }
        .style-card.active-style { border-color: var(--success); box-shadow: 0 0 15px rgba(46, 213, 115, 0.3); }

        /* LOGS */
        .log-entry { background: #2a2a2a; border-left: 5px solid var(--info); padding: 15px; margin-bottom: 15px; border-radius: 8px; }
        .log-version { font-size: 1.2em; font-weight: bold; color: var(--legend); margin-bottom: 5px; }
        
        /* TOASTS */
        #toast-area { position: fixed; bottom: 20px; right: 20px; z-index: 10000; display: flex; flex-direction: column; gap: 10px; }
        .toast { background: #252525; border-left: 4px solid var(--info); color: white; padding: 15px 20px; border-radius: 4px; box-shadow: 0 5px 15px rgba(0,0,0,0.5); animation: slideIn 0.3s ease; display:flex; align-items:center; gap:10px; }
        @keyframes slideIn { from { transform: translateX(100%); } to { transform: translateX(0); } }

        /* PROGRESS BARS */
        .progress-bg { background: #333; height: 6px; width: 100%; border-radius: 3px; overflow: hidden; margin-top: 5px; }
        .progress-fill { height: 100%; background: var(--success); width: 0%; transition: width 0.2s linear; }

    </style>
</head>
<body>

    <div class="modal" id="modal-start" style="display: flex;">
        <div class="modal-content" style="width: 500px; text-align: center;">
            <h1 style="color:var(--info); margin-bottom:10px;">‚ö° v 0.19 Chameleon</h1>
            <p style="color:#aaa; margin-bottom:30px;">Nouveau moteur graphique & Th√®mes visuels.</p>
            <button class="btn-fancy shop" onclick="startGame()" style="text-align:center; display:block; justify-content:center;">üèôÔ∏è Lancer la simulation</button>
            <br>
            <small style="color:#555; cursor:pointer" onclick="hardReset()">‚ö†Ô∏è Reset Sauvegarde</small>
        </div>
    </div>

    <div class="container">
        <header>
            <div style="display:flex; align-items:center; gap:10px;">
                <h1 style="margin:0">üì¶ Le Transporteur <span style="font-size:0.5em; background:var(--legend); color:#000; padding:2px 6px; border-radius:4px; vertical-align:middle;">V.19</span></h1>
                <button class="settings-btn" onclick="openSettingsModal()" title="Options d'affichage">üîß</button>
            </div>
            <div class="clock-display" id="clock">08:00</div>
            <div class="turbo-zone" id="turbo-zone"></div>
            <button class="btn-red" onclick="hardReset()" style="font-size:0.7em;">RESET</button>
        </header>

        <div class="stats-bar">
            <div class="stat-item"><span class="stat-label">Tr√©sorerie</span><span class="stat-value" id="money">0 ‚Ç¨</span></div>
            <div class="stat-item"><span class="stat-label">R√©putation</span><span class="stat-value text-green" id="reputation">0</span></div>
            <div class="stat-item"><span class="stat-label">Bonus Rep</span><span class="stat-value" style="color:var(--xp)" id="rep-bonus">+0%</span></div>
            <div class="stat-item"><span class="stat-label">Flotte</span><span class="stat-value"><span id="vehicles-count">0</span>/<span id="max-vehicles">5</span></span></div>
            <div class="stat-item"><span class="stat-label">Contrats</span><span class="stat-value"><span id="daily-missions">0</span></span></div>
        </div>

        <div class="grid-container">
            <div class="left-col">
                <div class="section">
                    <h2>üì° Radar Satellite <small id="fuel-price" style="font-size:0.7em; color:#888">‚õΩ -- ‚Ç¨</small></h2>
                    <div id="map-container">
                        <canvas id="game-canvas" width="900" height="500"></canvas>
                    </div>
                </div>

                <div class="section">
                    <h2>üìã Appels d'Offres <small style="font-size:0.6em; color:#888">Maj: 45min</small></h2>
                    <div id="active-missions-container" style="margin-bottom:20px;">
                        <h4 style="margin-top:0; color:#888; border-bottom:1px dashed #444;">En cours de livraison</h4>
                        <div id="active-missions-list"></div>
                    </div>
                    <div>
                        <h4 style="margin-top:0; color:#888; border-bottom:1px dashed #444;">En attente (Trier par Capacit√©)</h4>
                        <div class="tabs-wrapper">
                            <div id="tabs-header" class="tabs-header"></div>
                            <div id="tabs-content"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="right-col">
                <div class="section">
                    <h2>‚öôÔ∏è Gestion & RH</h2>
                    <button class="btn-fancy xp" onclick="openSkillsModal()"><span>üéì Comp√©tences</span><span class="icon">‚ö°</span></button>
                    <button class="btn-fancy shop" onclick="openModal('modal-shop')"><span>üöó Concessionnaire</span><span class="icon">üõí</span></button>
                    <button class="btn-fancy hire" onclick="openHireModal()"><span>‚ûï Recruter Personnel</span><span class="icon">üë§</span></button>
                    <button class="btn-fancy info" onclick="openLogModal()"><span>üì∞ Journal de Bord</span><span class="icon">üìú</span></button>
                </div>
                <div class="section">
                    <h2>üë∑ √âquipe Active</h2>
                    <div id="couriers-list"></div>
                </div>
                <div class="section">
                    <h2>üîß Garage <button class="btn-purple" style="font-size:0.6em; float:right" onclick="buyGarageSlot()">Agrandir (+1)</button></h2>
                    <div id="garage-list"></div>
                </div>
                <div class="section" style="border-top: 4px solid var(--purple);">
                    <h2 style="color:var(--purple)">üè¶ Banque</h2>
                    <div style="background:#2a2a2a; padding:10px; border-radius:6px; margin-bottom:10px; display:flex; justify-content:space-between;">
                        <span>Dette Actuelle:</span>
                        <span class="text-red" style="font-weight:bold" id="debt">0 ‚Ç¨</span>
                    </div>
                    <div style="display: flex; gap: 10px;">
                        <button class="btn-purple" style="flex:1" onclick="bankAction('loan')">Emprunter 5k</button>
                        <button style="flex:1; background:#444;" onclick="bankAction('repay')">Rembourser 1k</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="toast-area"></div>

    <div class="modal" id="modal-settings"><div class="modal-content" style="width:600px">
        <h2>üîß Options d'Affichage</h2>
        <p>Choisissez le style visuel de votre carte :</p>
        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:15px;">
            <div class="style-card" onclick="setMapStyle('base')" id="style-base">
                <div style="font-size:2em">‚ö™</div>
                <strong>Standard</strong><br><small>Sobre & Efficace</small>
            </div>
            <div class="style-card" onclick="setMapStyle('neon')" id="style-neon">
                <div style="font-size:2em">üü£</div>
                <strong>N√©on</strong><br><small>Flashy & Cyberpunk</small>
            </div>
            <div class="style-card" onclick="setMapStyle('radar')" id="style-radar">
                <div style="font-size:2em">üü¢</div>
                <strong>Radar</strong><br><small>Tactique & Pro</small>
            </div>
            <div class="style-card" onclick="setMapStyle('data')" id="style-data">
                <div style="font-size:2em">üîµ</div>
                <strong>Data Stream</strong><br><small>Vivant & Flux</small>
            </div>
        </div>
        <br>
        <button class="btn-fancy info" onclick="closeModal('modal-settings')">Valider</button>
    </div></div>

    <div class="modal" id="modal-shop"><div class="modal-content"><h2>üè¢ Concessionnaire Elite</h2><div class="filter-bar"><button class="filter-btn active" onclick="filterShop('urban', this)">üèôÔ∏è Urbain</button><button class="filter-btn" onclick="filterShop('sport', this)">üèéÔ∏è Sport</button><button class="filter-btn" onclick="filterShop('suv', this)">üöô SUV</button><button class="filter-btn" onclick="filterShop('heavy', this)">üöõ Lourd</button><button class="filter-btn" style="color:#aaa" onclick="filterShop('mil', this)">ü™ñ Militaire</button><button class="filter-btn" onclick="filterShop('air', this)">‚úàÔ∏è A√©rien</button><button class="filter-btn" style="color:var(--mythic)" onclick="filterShop('mythic', this)">ü¶Ñ Mythique</button></div><div id="shop-grid" class="shop-grid"></div><button class="btn-fancy shop" onclick="closeModal('modal-shop')">Fermer</button></div></div>
    <div class="modal" id="modal-hire"><div class="modal-content"><h2>üëî Cabinet de Recrutement</h2><div class="filter-bar"><button class="filter-btn active" onclick="filterHire('beginner', this)">D√©butants</button><button class="filter-btn" onclick="filterHire('pro', this)">Pros</button><button class="filter-btn" onclick="filterHire('expert', this)">Experts</button><button class="filter-btn" onclick="filterHire('creature', this)">Cr√©atures</button><button class="filter-btn" style="color:var(--legend)" onclick="filterHire('legend', this)">L√©gendes</button></div><div id="hire-grid" class="shop-grid"></div><button class="btn-fancy hire" onclick="closeModal('modal-hire')">Fermer</button></div></div>
    <div class="modal" id="modal-skills"><div class="modal-content"><h2>üéì Comp√©tences & Manager</h2><div id="skills-grid" class="shop-grid"></div><button class="btn-fancy xp" onclick="closeModal('modal-skills')">Fermer</button></div></div>
    <div class="modal" id="modal-assign"><div class="modal-content" style="width:400px"><h2>Attribuer V√©hicule</h2><div id="assign-grid" class="shop-grid"></div><button class="btn-fancy shop" onclick="closeModal('modal-assign')">Fermer</button></div></div>
    <div class="modal" id="modal-log"><div class="modal-content"><h2>üìú Journal de Bord</h2><div id="log-content" style="margin-top:20px;"></div><button class="btn-fancy info" onclick="closeModal('modal-log')">Fermer</button></div></div>

    <script>
        /* -------------------------------------------------------------------------- */
        /* CONFIGURATION STATIQUE (IMMUTABLE)                                     */
        /* -------------------------------------------------------------------------- */
        const SAVE_KEY = "ELITE_V19";

        // Catalogue de r√©f√©rence des v√©hicules.
        // Chaque entr√©e d√©finit les propri√©t√©s physiques (vitesse, capacit√©) et √©conomiques.
        // 'icon' est utilis√© pour le rendu Canvas et DOM.
        const VEHICLES = [
            { id: 'skate', cat: 'urban', name: "Skate", price: 50, speed: 15, cap: 1, icon: 'üõπ', desc: "√áa roule." },
            { id: 'trot', cat: 'urban', name: "Trottinette", price: 200, speed: 20, cap: 1, icon: 'üõ¥', desc: "√âlectrique." },
            { id: 'bike', cat: 'urban', name: "V√©lo", price: 500, speed: 30, cap: 1, icon: 'üö≤', desc: "√âcologique." },
            { id: 'scoot', cat: 'urban', name: "Scooter", price: 2000, speed: 60, cap: 2, icon: 'üõµ', desc: "Standard." },
            { id: 'twingo', cat: 'urban', name: "Citadine", price: 5000, speed: 70, cap: 4, icon: 'üöó', desc: "Pratique." },
            { id: 'taxi', cat: 'urban', name: "Taxi", price: 10000, speed: 75, cap: 3, icon: 'üöï', desc: "Pro." },
            { id: 'rollers', cat: 'urban', name: "Rollers", price: 100, speed: 40, cap: 1, icon: 'üõº', desc: "L√©ger." },
            { id: 'caddie', cat: 'urban', name: "Caddie", price: 300, speed: 10, cap: 5, icon: 'üõí', desc: "Low-cost." },
            { id: 'scoot_mob', cat: 'urban', name: "Scooter Mobilit√©", price: 400, speed: 20, cap: 1, icon: 'ü¶º', desc: "Accessibilit√©." },
            { id: 'kart', cat: 'sport', name: "Karting", price: 8000, speed: 85, cap: 1, icon: 'üèéÔ∏è', desc: "Fun." },
            { id: 'rally', cat: 'sport', name: "Rallye", price: 15000, speed: 110, cap: 2, icon: 'üöôüí®', desc: "Drift." },
            { id: 'muscle', cat: 'sport', name: "Muscle Car", price: 25000, speed: 130, cap: 2, icon: 'üöò', desc: "V8." },
            { id: 'hyper', cat: 'sport', name: "Hypercar", price: 60000, speed: 200, cap: 1, icon: 'üèéÔ∏èüî•', desc: "Fus√©e au sol." },
            { id: 'comet', cat: 'sport', name: "Com√®te", price: 80000, speed: 250, cap: 1, icon: 'üí´', desc: "Ultra-rapide." },
            { id: 'moto_race', cat: 'sport', name: "Moto Course", price: 30000, speed: 150, cap: 1, icon: 'üèçÔ∏è', desc: "Agile." },
            { id: 'suv', cat: 'suv', name: "SUV Famille", price: 12000, speed: 75, cap: 6, icon: 'üöô', desc: "Confort." },
            { id: 'jeep', cat: 'suv', name: "4x4", price: 16000, speed: 65, cap: 4, icon: 'üõª', desc: "Franchissement." },
            { id: 'luxe_suv', cat: 'suv', name: "G-Wagon", price: 35000, speed: 90, cap: 5, icon: 'üöê‚ú®', desc: "Prestige." },
            { id: 'elephant', cat: 'suv', name: "√âl√©phant", price: 50000, speed: 40, cap: 30, icon: 'üêò', desc: "Tout-terrain lourd." },
            { id: 'van', cat: 'heavy', name: "Van", price: 8000, speed: 55, cap: 8, icon: 'üöê', desc: "Volume moyen." },
            { id: 'truck', cat: 'heavy', name: "Semi", price: 30000, speed: 50, cap: 20, icon: 'üöõ', desc: "Gros volume." },
            { id: 'bus', cat: 'heavy', name: "Bus", price: 40000, speed: 45, cap: 25, icon: 'üöå', desc: "Transport commun." },
            { id: 'cargo', cat: 'heavy', name: "Cargo", price: 150000, speed: 30, cap: 200, icon: 'üö¢', desc: "Colossal." },
            { id: 'train', cat: 'heavy', name: "Train Vapeur", price: 70000, speed: 70, cap: 50, icon: 'üöÇ', desc: "Sur rails." },
            { id: 'humvee', cat: 'mil', name: "Humvee", price: 45000, speed: 70, cap: 6, icon: 'ü™ñüöô', desc: "Blind√© l√©ger." },
            { id: 'apc', cat: 'mil', name: "VAB", price: 65000, speed: 60, cap: 10, icon: 'üß±', desc: "Transport de troupes." },
            { id: 'tank', cat: 'mil', name: "Tank", price: 90000, speed: 40, cap: 4, icon: 'üí•', desc: "Force brute." },
            { id: 'stealth', cat: 'mil', name: "Jet F-22", price: 150000, speed: 300, cap: 2, icon: '‚úàÔ∏èüåë', fly: true, desc: "Invisible." },
            { id: 'mil_heli', cat: 'mil', name: "H√©licopt√®re Militaire", price: 95000, speed: 180, cap: 12, icon: 'üöÅ', fly: true, desc: "Transport arm√©." },
            { id: 'drone', cat: 'air', name: "Drone", price: 25000, speed: 100, cap: 2, icon: 'üöÅ', fly: true, desc: "Agile." },
            { id: 'plane', cat: 'air', name: "Cessna", price: 50000, speed: 160, cap: 8, icon: '‚úàÔ∏è', fly: true, desc: "Rapide." },
            { id: 'rocket', cat: 'air', name: "Fus√©e", price: 100000, speed: 250, cap: 5, icon: 'üöÄ', fly: true, desc: "Orbital." },
            { id: 'ufo', cat: 'air', name: "OVNI", price: 500000, speed: 400, cap: 50, icon: 'üõ∏', fly: true, desc: "Alien." },
            { id: 'satellite', cat: 'air', name: "Satellite", price: 120000, speed: 500, cap: 1, icon: 'üõ∞Ô∏è', fly: true, desc: "Orbital." },
            { id: 'balloon', cat: 'air', name: "Montgolfi√®re", price: 15000, speed: 20, cap: 40, icon: 'üéà', fly: true, desc: "Volume, mais lenteur." },
            { id: 'eagle', cat: 'air', name: "Aigle G√©ant", price: 100000, speed: 150, cap: 5, icon: 'ü¶Ö', fly: true, desc: "Biologique." },
            { id: 'dragon', cat: 'mythic', name: "Dragon", price: 1000000, speed: 300, cap: 100, icon: 'üêâ', fly: true, desc: "Feu." },
            { id: 'unicorn', cat: 'mythic', name: "Licorne", price: 800000, speed: 200, cap: 10, icon: 'ü¶Ñ', fly: true, desc: "Magie." },
            { id: 'carpet', cat: 'mythic', name: "Tapis", price: 500000, speed: 180, cap: 4, icon: 'üßû‚Äç‚ôÇÔ∏è', fly: true, desc: "R√™ve bleu." },
            { id: 'dolphin', cat: 'mythic', name: "Dauphin", price: 400000, speed: 100, cap: 8, icon: 'üê¨', fly: true, desc: "Aquatique/Amphibie." },
            { id: 'bear', cat: 'mythic', name: "Ours G√©ant", price: 300000, speed: 80, cap: 20, icon: 'üêª', desc: "Force brute." },
            { id: 'ghost', cat: 'mythic', name: "Fant√¥me", price: 999999, speed: 999, cap: 1, icon: 'üëª', fly: true, desc: "T√©l√©portation (tr√®s rare)." }
        ];

        // Catalogue de r√©f√©rence du personnel.
        // D√©finit les multiplicateurs de vitesse (spd) et de revenu (earn).
        const RECRUITS = [
            { id: 'intern', cat: 'beginner', name: "Stagiaire", price: 200, spd: 0.8, earn: 1.0, icon: 'üë∂', desc: "Apprend vite." },
            { id: 'student', cat: 'beginner', name: "√âtudiant", price: 300, spd: 0.9, earn: 1.0, icon: 'üéí', desc: "Job d'√©t√©." },
            { id: 'sleeper', cat: 'beginner', name: "Le Dormeur", price: 100, spd: 0.6, earn: 0.9, icon: 'üò¥', desc: "Peut rater des missions." },
            { id: 'gamer', cat: 'beginner', name: "Gamer", price: 400, spd: 0.9, earn: 1.0, icon: 'üéÆ', desc: "Bonus de nuit." },
            { id: 'cook', cat: 'beginner', name: "Cuisinier", price: 500, spd: 1.0, earn: 1.1, icon: 'üßë‚Äçüç≥', desc: "Sp√©cialiste de la nourriture." },
            { id: 'pro', cat: 'pro', name: "Livreur Pro", price: 1500, spd: 1.0, earn: 1.0, icon: 'üë∑', desc: "Standard." },
            { id: 'cop', cat: 'pro', name: "Policier", price: 2000, spd: 1.1, earn: 1.0, icon: 'üëÆ', desc: "Respect√©." },
            { id: 'kungfu', cat: 'pro', name: "M. Kung-Fu", price: 3500, spd: 1.3, earn: 1.0, icon: 'ü•ã', desc: "Agile, v√©hicules l√©gers." },
            { id: 'reporter', cat: 'pro', name: "Reporter", price: 4000, spd: 1.1, earn: 1.2, icon: 'üéôÔ∏è', desc: "Atteint les zones chaudes." },
            { id: 'coder', cat: 'pro', name: "Codeur", price: 5000, spd: 1.0, earn: 1.3, icon: 'üë®‚Äçüíª', desc: "Optimisation des circuits." },
            { id: 'racer', cat: 'expert', name: "Pilote F1", price: 8000, spd: 1.8, earn: 1.0, icon: 'üèéÔ∏èüë§', desc: "Adr√©naline." },
            { id: 'general', cat: 'expert', name: "G√©n√©ral", price: 10000, spd: 1.0, earn: 1.5, icon: 'üéñÔ∏è', desc: "Strat√®ge." },
            { id: 'bodyguard', cat: 'expert', name: "Garde", price: 9000, spd: 1.2, earn: 1.2, icon: 'üï∂Ô∏è', desc: "S√ªr." },
            { id: 'robot', cat: 'creature', name: "Robot", price: 10000, spd: 1.2, earn: 1.2, icon: 'ü§ñ', desc: "Incassable." },
            { id: 'alien', cat: 'creature', name: "Alien", price: 12000, spd: 1.8, earn: 1.0, icon: 'üëΩ', desc: "Techno." },
            { id: 'gorilla', cat: 'creature', name: "Gorille", price: 15000, spd: 1.0, earn: 1.1, icon: 'ü¶ç', desc: "Force (Bonus Lourds)." },
            { id: 'vampire', cat: 'creature', name: "Vampire", price: 18000, spd: 1.5, earn: 1.3, icon: 'üßõ', desc: "Travail de nuit." },
            { id: 'wizard', cat: 'creature', name: "Sorcier", price: 20000, spd: 1.0, earn: 1.8, icon: 'üßô‚Äç‚ôÇÔ∏è', desc: "Magie logistique." },
            { id: 'dino', cat: 'creature', name: "Dinosaure", price: 22000, spd: 0.9, earn: 1.0, icon: 'ü¶ñ', desc: "√âvite les accidents." },
            { id: 'santa', cat: 'legend', name: "P√®re No√´l", price: 50000, spd: 1.5, earn: 2.0, icon: 'üéÖ', desc: "Ho Ho Ho!" },
            { id: 'hacker', cat: 'legend', name: "Hacker", price: 70000, spd: 1.0, earn: 3.0, icon: 'üíª', desc: "D√©tourne les fonds." },
            { id: 'hero', cat: 'legend', name: "Super-H√©ros", price: 100000, spd: 2.0, earn: 1.5, icon: 'ü¶∏', desc: "Le meilleur." },
            { id: 'monarch', cat: 'legend', name: "Monarque", price: 85000, spd: 1.0, earn: 2.5, icon: 'üëë', desc: "Exige le luxe." },
            { id: 'time_traveler', cat: 'legend', name: "V. Temporel", price: 90000, spd: 1.2, earn: 2.0, icon: '‚è≥', desc: "Annule 1 √©chec/jour." }
        ];

        // Catalogue des am√©liorations passives.
        const SKILLS_CATALOG = [
            { id: 'auto_manager', name: "Manager IA", price: 25000, icon: 'ü§ñ', desc: "Assigne AUTOMATIQUEMENT les missions aux livreurs libres." },
            { id: 'mechanic', name: "M√©cano Chef", price: 5000, icon: 'üîß', desc: "Maintenance gratuite des v√©hicules." },
            { id: 'ad_agency', name: "Publicitaire", price: 8000, icon: 'üì∫', desc: "+20% de R√©putation." },
            { id: 'fuel_eco', name: "Eco-Conduite", price: 10000, icon: 'üçÉ', desc: "Co√ªts journaliers r√©duits de 30%." },
            { id: 'speed_logistics', name: "Nitro-Logistique", price: 15000, icon: 'üöÄ', desc: "Tous les v√©hicules vont 10% plus vite." },
            { id: 'promoter', name: "Promoteur", price: 12000, icon: 'üìà', desc: "+50% fr√©quence missions." },
            { id: 'negotiator', name: "N√©gociateur", price: 20000, icon: 'ü§ù', desc: "Gains +15%." }
        ];

        // Historique des patchs pour le changelog in-game.
        const VERSION_LOG = [
            {
                version: "V0.19: Chameleon",
                date: "Maintenant",
                notes: [
                    "üé® **Moteur Graphique :** Ajout du menu 'Options' (Cl√© √† molette) pour changer le style de la carte.",
                    "‚ú® **4 Styles :** Base, N√©on (Cyberpunk), Radar (Militaire) et Data Stream (Matrix).",
                    "üíæ **Persistance :** Votre choix de style est sauvegard√©."
                ]
            },
            {
                version: "V0.18: Tabs Edition",
                date: "Hier",
                notes: [ "üóÇÔ∏è Onglets de Missions.", "‚úÖ Tri Intelligent." ]
            }
        ];

        // Dictionnaires pour la g√©n√©ration proc√©durale des noms de mission.
        const M_VERBS = ["Livraison", "Transport", "R√©cup√©ration", "Envoi", "Sauvetage", "Transfert", "Exp√©dition", "Acheminement", "Convoyage", "Distribution", "Affr√®tement", "Relocalisation", "Collecte", "D√©p√¥t", "Saisine", "Remise", "√âvacuation", "Rapatriement", "Approvisionnement", "Portage", "Aiguillage", "Manutention", "R√©ception", "Logistique", "Transit", "Restitution", "Cession"];
        const M_OBJECTS = ["de Pizzas üçï", "de Documents üìÑ", "d'Organes ü´Ä", "de Meubles üõãÔ∏è", "de Sushis üç£", "de Briques üß±", "de Billets üí∏", "de Fleurs üåπ", "de Vaccins üíâ", "d'Uranium ‚ò¢Ô∏è", "de Chatons üê±", "de Colis üì¶", "de M√©dicaments üíä", "d'√âchantillons üî¨", "de Pi√®ces D√©tach√©es üî©", "de Marchandises üõí", "de Courrier ‚úâÔ∏è", "d'Animaux üêæ", "d'Antiquit√©s üè∫", "de Devise üí∂", "de Conteneurs üö¢", "d'Outils üõ†Ô∏è", "de Mati√®res Premi√®res ü™®", "de Donn√©es üíæ", "de Ravitaillement ü•´", "de Liquides üíß", "d'≈íuvres d'Art üñºÔ∏è", "de Passagers üë§", "d'Armes üî´", "de Mat√©riel Sportif ‚öΩ", "de Proth√®ses ü¶æ", "d'Hydrocarbures ‚õΩ"];
        const M_CONTEXT = ["Urgent", "Fragile", "VIP", "Secret", "Nocturne", "Express", "Discret", "Prioritaire", "S√©curis√©", "D√©licat", "Confidentiel", "Souterrain", "Sur-Mesure", "Anonyme", "Haute-Valeur", "R√©glement√©", "Premium", "Ultra-Rapide", "Quotidien", "Diplomatique", "Climatis√©", "Sp√©cialis√©", "P√©rissable", "Sans-Contact", "En-Masse", "Temporis√©", "Brouill√©"];

        /* -------------------------------------------------------------------------- */
        /* √âTAT GLOBAL (MUTABLE)                                                   */
        /* -------------------------------------------------------------------------- */
        // Contient l'int√©gralit√© des donn√©es de la session courante.
        // Objet s√©rialis√© en JSON lors de la sauvegarde.
        let state = {
            money: 3000, debt: 0, reputation: 0,
            time: 480, day: 1, speed: 1,
            couriers: [], vehicles: [], missions: [], 
            skills: {}, 
            maxVehicles: 5,
            stats: { missionsToday: 0 },
            cheatUsed: false,
            activeTab: 1,
            mapStyle: 'base' // default
        };

        // Filtres d'affichage temporaires (non sauvegard√©s).
        let currentShopFilter = 'urban';
        let currentHireFilter = 'beginner';

        /* -------------------------------------------------------------------------- */
        /* MOTEUR GRAPHIQUE (CANVAS RENDERER)                                      */
        /* -------------------------------------------------------------------------- */
        const GFX = {
            canvas: null, ctx: null, width: 0, height: 0, 
            nodes: [], hubs: [], hq: {x:0, y:0}, // Graphe de navigation
            particles: [], radarAngle: 0,
            
            // Initialisation du contexte graphique.
            init: function() {
                this.canvas = document.getElementById('game-canvas');
                this.ctx = this.canvas.getContext('2d');
                this.resize();
                window.addEventListener('resize', () => this.resize());
                
                // Pr√©-allocation des particules pour le mode 'Data'.
                for(let i=0; i<50; i++) this.particles.push({ x:0, y:0, tx:0, ty:0, p:0, active:false });
            },
            
            // Gestion du responsive : redimensionne le canvas interne pour correspondre au CSS.
            resize: function() {
                if(!this.canvas) return;
                const rect = this.canvas.getBoundingClientRect();
                this.canvas.width = rect.width; this.canvas.height = rect.height;
                this.width = rect.width; this.height = rect.height;
                this.hq = { x: this.width/2, y: this.height/2 };
                if(this.nodes.length === 0) this.generateCity();
            },
            
            // G√©n√©ration proc√©durale de la topologie de la ville.
            // Cr√©e un syst√®me en √©toile : QG -> Hubs -> Nodes (boutiques/clients).
            generateCity: function() {
                this.nodes = []; this.hubs = [];
                const hubCount = 6;
                // Cr√©ation des Hubs principaux autour du QG.
                for(let i=0; i<hubCount; i++) {
                    const angle = (i / hubCount) * Math.PI * 2;
                    const dist = this.height * 0.35;
                    this.hubs.push({ x: this.hq.x + Math.cos(angle)*dist, y: this.hq.y + Math.sin(angle)*dist });
                }
                // Dispersion al√©atoire des nodes et rattachement au Hub le plus proche.
                for(let i=0; i<50; i++) {
                    const x = Math.random() * (this.width - 40) + 20;
                    const y = Math.random() * (this.height - 40) + 20;
                    let nearest = this.hubs[0], minD = 99999;
                    this.hubs.forEach(h => { const d = Math.hypot(x-h.x, y-h.y); if(d < minD) { minD=d; nearest=h; } });
                    this.nodes.push({ x: x, y: y, type: Math.random()>0.4?'client':'shop', hub: nearest });
                }
            },
            
            // Calculs d'animation frame-par-frame.
            update: function() {
                // Rotation du radar.
                this.radarAngle += 0.05;
                
                // Physique des particules (Mode Data).
                if(state.mapStyle === 'data') {
                    this.particles.forEach(p => {
                        if(!p.active) {
                            // Respawn al√©atoire d'une particule entre deux hubs.
                            if(Math.random() > 0.9) {
                                const start = this.hubs[Math.floor(Math.random()*this.hubs.length)];
                                const end = this.hubs[Math.floor(Math.random()*this.hubs.length)];
                                if(start !== end) {
                                    p.active = true; p.x = start.x; p.y = start.y; p.tx = end.x; p.ty = end.y; p.p = 0;
                                }
                            }
                        } else {
                            // Interpolation (Lerp) de la position.
                            p.p += 0.02;
                            p.x = p.x + (p.tx - p.x) * 0.02;
                            p.y = p.y + (p.ty - p.y) * 0.02;
                            if(p.p >= 1) p.active = false;
                        }
                    });
                }
            },

            // Pipeline de rendu principal.
            draw: function() {
                if(!this.ctx) return;
                this.update();
                const ctx = this.ctx;
                
                // D√©finition des palettes de couleurs selon le th√®me.
                const themes = {
                    'base': { bg: '#000', road: '#222', hub: '#555', node: '#e74c3c', shop: '#3498db', shadow: 0 },
                    'neon': { bg: '#0a0a12', road: '#d63031', hub: '#a29bfe', node: '#ff7675', shop: '#74b9ff', shadow: 15, glow: 'cyan' },
                    'radar': { bg: '#001a00', road: '#003300', hub: '#004400', node: '#00ff00', shop: '#00cc00', shadow: 0 },
                    'data': { bg: '#111', road: '#333', hub: '#444', node: '#eee', shop: '#ccc', shadow: 0 }
                };
                const t = themes[state.mapStyle] || themes['base'];

                // 1. Fond
                ctx.fillStyle = t.bg;
                ctx.fillRect(0,0,this.width, this.height);

                // 2. Effet Radar (Gradient Conique)
                if(state.mapStyle === 'radar') {
                    const grad = ctx.createConicGradient(this.radarAngle, this.hq.x, this.hq.y);
                    grad.addColorStop(0, 'rgba(0, 255, 0, 0)');
                    grad.addColorStop(0.1, 'rgba(0, 255, 0, 0.3)');
                    grad.addColorStop(1, 'rgba(0, 255, 0, 0)');
                    ctx.fillStyle = grad; ctx.beginPath(); ctx.arc(this.hq.x, this.hq.y, this.width, 0, Math.PI*2); ctx.fill();
                }

                // 3. R√©seau Routier (Lignes)
                ctx.shadowBlur = t.shadow; ctx.shadowColor = t.glow || "transparent";
                ctx.lineWidth = state.mapStyle === 'neon' ? 3 : 2;
                ctx.strokeStyle = t.road;
                
                this.hubs.forEach(h => { ctx.beginPath(); ctx.moveTo(this.hq.x, this.hq.y); ctx.lineTo(h.x, h.y); ctx.stroke(); });
                ctx.lineWidth = 1;
                if(state.mapStyle === 'radar') ctx.strokeStyle = "#004400";
                this.nodes.forEach(n => { ctx.beginPath(); ctx.moveTo(n.hub.x, n.hub.y); ctx.lineTo(n.x, n.y); ctx.stroke(); });
                ctx.shadowBlur = 0;

                // 4. Particules de donn√©es
                if(state.mapStyle === 'data') {
                    ctx.fillStyle = "#fff";
                    this.particles.forEach(p => { if(p.active) ctx.fillRect(p.x, p.y, 2, 2); });
                }

                // 5. Noeuds (Villes/Commerces)
                this.hubs.forEach(h => { ctx.fillStyle=t.hub; ctx.beginPath(); ctx.arc(h.x, h.y, 4, 0, Math.PI*2); ctx.fill(); });
                this.nodes.forEach(n => { 
                    ctx.fillStyle = n.type==='shop' ? t.shop : t.node; 
                    ctx.beginPath(); 
                    if(state.mapStyle === 'radar') ctx.fillRect(n.x-2, n.y-2, 4, 4); 
                    else ctx.arc(n.x, n.y, 3, 0, Math.PI*2); 
                    ctx.fill(); 
                });
                
                // 6. QG (Centre)
                ctx.fillStyle = state.mapStyle === 'radar' ? '#00ff00' : "#2ed573"; 
                ctx.beginPath(); ctx.arc(this.hq.x, this.hq.y, 7, 0, Math.PI*2); ctx.fill();

                // 7. V√©hicules (Interpolation de position selon progression mission)
                state.missions.forEach(m => {
                    if(m.status === 'active' && m.targetNode) {
                        const c = state.couriers.find(x => x.id === m.cId);
                        const v = state.vehicles.find(x => x.id === c.vehicleId);
                        if(!v) return;
                        let vx, vy;
                        const p = m.progress / 100;
                        
                        // Calcul vectoriel de la position actuelle.
                        if(v.fly) {
                            // Vol direct (Ligne droite)
                            vx = this.hq.x + (m.targetNode.x - this.hq.x) * p;
                            vy = this.hq.y + (m.targetNode.y - this.hq.y) * p;
                        } else {
                            // Trajet routier (QG -> Hub -> Node)
                            const hub = m.targetNode.hub || this.hubs[0];
                            const d1 = Math.hypot(hub.x - this.hq.x, hub.y - this.hq.y);
                            const d2 = Math.hypot(m.targetNode.x - hub.x, m.targetNode.y - hub.y);
                            const currentDist = p * (d1+d2);
                            if(currentDist < d1) {
                                const subP = currentDist / d1;
                                vx = this.hq.x + (hub.x - this.hq.x) * subP;
                                vy = this.hq.y + (hub.y - this.hq.y) * subP;
                            } else {
                                const subP = (currentDist - d1) / d2;
                                vx = hub.x + (m.targetNode.x - hub.x) * subP;
                                vy = hub.y + (m.targetNode.y - hub.y) * subP;
                            }
                        }
                        ctx.font = "16px Arial"; ctx.textAlign="center"; ctx.textBaseline="middle";
                        ctx.fillText(v.icon, vx, vy);
                    }
                });
            }
        };

        /* -------------------------------------------------------------------------- */
        /* LOGIQUE DE JEU (GAME LOOP)                                              */
        /* -------------------------------------------------------------------------- */
        
        // Initialisation et d√©marrage de la boucle.
        function startGame() {
            document.getElementById('modal-start').style.display = 'none';
            GFX.init(); GFX.generateCity();
            loadGame();
            // Cr√©ation des assets de d√©part si nouvelle partie.
            if(state.couriers.length === 0) {
                state.money = 3000;
                state.couriers.push({ id: Date.now(), name: "Le Patron", level: 1, xp: 0, busy: false, vehicleId: null, spd: 1.2, earn: 1.0 });
                const bike = { ...VEHICLES.find(v=>v.id==='bike'), id: Date.now()+1, condition: 100, assignedTo: state.couriers[0].id };
                state.vehicles.push(bike);
                state.couriers[0].vehicleId = bike.id;
            }
            while(state.missions.length < 6) generateMission();
            if (window.gameInterval) clearInterval(window.gameInterval);
            window.gameInterval = setInterval(gameLoop, 100);
            updateUI();
        }

        // Boucle principale (Tick).
        function gameLoop() {
            if(state.speed === 0) return;
            
            // Avancement du temps (Minutes).
            state.time += 0.2 * state.speed;
            
            // Cycle journalier (1440 min = 24h).
            if(state.time >= 1440) { state.time = 0; state.day++; state.stats.missionsToday = 0; payDailyCosts(); }
            
            // G√©n√©ration p√©riodique de missions (Intervalle variable selon comp√©tences).
            const checkTime = Math.floor(state.time);
            const freq = state.skills.promoter ? 30 : 45; 
            if(checkTime % freq === 0 && checkTime !== state.lastMissionCheck) { 
                state.lastMissionCheck = checkTime; 
                if(Math.random() > 0.2) generateMission(); 
            }
            
            // Automation (Comp√©tence Manager IA).
            if(state.skills.auto_manager && checkTime % 2 === 0) { 
                state.missions.forEach(m => {
                    if(m.status === 'pending') {
                        const worker = state.couriers.find(c => !c.busy && c.vehicleId && state.vehicles.find(v=>v.id===c.vehicleId).cap >= m.slots);
                        if(worker) acceptMission(m.id, state.couriers.indexOf(worker));
                    }
                });
            }
            
            // Physique des missions (Calcul de progression).
            // Vitesse = (Base V√©hicule * Multiplicateur Livreur) / Distance
            state.missions.forEach(m => {
                if(m.status === 'active') {
                    const c = state.couriers.find(x => x.id === m.cId);
                    const v = state.vehicles.find(x => x.id === c.vehicleId);
                    if(c && v) {
                        let spd = v.speed * (c.spd || 1.0);
                        if(state.skills.mechanic) spd *= 1.1; 
                        if(state.skills.speed_logistics) spd *= 1.1; 
                        m.progress += (spd / m.distance) * 2.5 * state.speed;
                        if(m.progress >= 100) completeMission(m);
                    }
                }
            });
            
            GFX.draw();
            updateClock();
        }

        // G√©n√©rateur stochastique de missions.
        function generateMission() {
            if(!GFX.nodes.length) return;
            if(state.missions.filter(m=>m.status==='pending').length > 25) return;
            
            // Construction du nom et des param√®tres.
            const verb = M_VERBS[Math.floor(Math.random() * M_VERBS.length)];
            const obj = M_OBJECTS[Math.floor(Math.random() * M_OBJECTS.length)];
            const ctx = Math.random() > 0.6 ? M_CONTEXT[Math.floor(Math.random() * M_CONTEXT.length)] : "";
            const name = `${verb} ${ctx} ${obj}`;
            const target = GFX.nodes[Math.floor(Math.random() * GFX.nodes.length)];
            const dist = 500; // Distance abstraite standardis√©e
            
            // Pond√©ration des capacit√©s requises (Slot).
            let capReq = 1; const r = Math.random();
            if(r < 0.6) capReq = Math.floor(Math.random() * 2) + 1; 
            else if(r < 0.9) capReq = Math.floor(Math.random() * 4) + 1; 
            else capReq = Math.floor(Math.random() * 10) + 1; 
            
            const timeEst = Math.floor((dist / 30) * 4); 
            let baseReward = 50 + (capReq * 20) + (Math.random() * 50);
            
            state.missions.push({ id: Date.now() + Math.random(), name: name, slots: capReq, reward: Math.floor(baseReward), timeEst: timeEst, status: 'pending', progress: 0, targetNode: target, distance: dist, cId: null });
            updateUI();
        }

        // R√©solution de mission r√©ussie.
        function completeMission(m) {
            let gain = m.reward * (1 + (state.reputation / 100));
            if(state.skills.negotiator) gain *= 1.15;
            const c = state.couriers.find(x => x.id === m.cId);
            if(c && c.earn) gain *= c.earn;
            
            state.money += gain;
            state.reputation = parseFloat((state.reputation + (state.skills.ad_agency ? 1.2 : 1)).toFixed(1));
            
            // Leveling du livreur.
            if(c) { c.busy = false; c.xp += 10; if(c.xp >= c.level*100) { c.level++; c.xp=0; }}
            
            state.missions = state.missions.filter(x => x.id !== m.id);
            updateUI(); notify(`Mission termin√©e: +${Math.floor(gain)}‚Ç¨`, "success");
        }

        // Affectation d'un livreur √† une mission.
        function acceptMission(mId, cIndex) {
            const m = state.missions.find(x => x.id === mId); const c = state.couriers[cIndex]; const v = state.vehicles.find(x => x.id === c.vehicleId);
            if(!m || !c || !v) return; if(v.cap < m.slots) return notify("V√©hicule trop petit !", "error"); if(c.busy) return notify("D√©j√† occup√© !", "error");
            m.status = 'active'; m.cId = c.id; c.busy = true; updateUI();
        }

        /* -------------------------------------------------------------------------- */
        /* INTERFACE UTILISATEUR & DOM                                            */
        /* -------------------------------------------------------------------------- */
        
        function openSettingsModal() {
            document.querySelectorAll('.style-card').forEach(el => el.classList.remove('active-style'));
            const active = document.getElementById('style-' + state.mapStyle);
            if(active) active.classList.add('active-style');
            document.getElementById('modal-settings').style.display = 'flex';
        }

        // Changement dynamique du th√®me CSS/Canvas.
        function setMapStyle(style) {
            state.mapStyle = style;
            document.querySelectorAll('.style-card').forEach(el => el.classList.remove('active-style'));
            document.getElementById('style-' + style).classList.add('active-style');
            const canvas = document.getElementById('map-container');
            if(style === 'neon') canvas.style.borderColor = '#ff7675';
            else if(style === 'radar') canvas.style.borderColor = '#00ff00';
            else canvas.style.borderColor = '#333';
        }

        function setActiveTab(cap) { state.activeTab = cap; updateUI(); }

        // Reconstruction compl√®te du DOM (Approche Reactive simple).
        function updateUI() {
            document.getElementById('money').innerText = Math.floor(state.money) + " ‚Ç¨";
            document.getElementById('debt').innerText = Math.floor(state.debt) + " ‚Ç¨";
            document.getElementById('reputation').innerText = Math.floor(state.reputation);
            document.getElementById('rep-bonus').innerText = "+" + Math.floor(state.reputation) + "%";
            document.getElementById('vehicles-count').innerText = state.vehicles.length;
            document.getElementById('max-vehicles').innerText = state.maxVehicles;
            document.getElementById('daily-missions').innerText = state.missions.filter(m => m.status === 'active').length;

            // Rendu des missions actives (Barres de progression).
            const activeMissions = state.missions.filter(m => m.status === 'active');
            document.getElementById('active-missions-list').innerHTML = activeMissions.length ? activeMissions.map(m => {
                const c = state.couriers.find(x => x.id === m.cId);
                return `<div class="card card-active"><div><strong>${m.name}</strong><br><small>Livreur: ${c?c.name:'?'}</small></div><div style="width:100px"><div class="progress-bg"><div class="progress-fill" style="width:${m.progress}%"></div></div></div></div>`;
            }).join('') : '<div style="padding:10px; text-align:center; color:#555">Aucune livraison en cours</div>';

            // Rendu des onglets (Tri des missions par capacit√©).
            const pendingMissions = state.missions.filter(m => m.status === 'pending');
            let grouped = {}; pendingMissions.forEach(m => { if(!grouped[m.slots]) grouped[m.slots] = []; grouped[m.slots].push(m); });
            let caps = Object.keys(grouped).sort((a,b) => parseInt(a) - parseInt(b));
            if(caps.length > 0 && !grouped[state.activeTab]) state.activeTab = parseInt(caps[0]);

            document.getElementById('tabs-header').innerHTML = caps.map(cap => {
                return `<button class="tab-btn ${(parseInt(cap)===state.activeTab)?'active':''}" onclick="setActiveTab(${cap})">Cap. ${cap} (${grouped[cap].length})</button>`;
            }).join('');

            let contentHTML = '';
            if(caps.length === 0) contentHTML = '<div style="padding:20px; text-align:center; color:#555">Aucune offre. Attendez...</div>';
            else if (grouped[state.activeTab]) {
                let sorted = grouped[state.activeTab].sort((a,b) => a.id - b.id);
                const avail = state.couriers.filter(c => !c.busy && c.vehicleId);
                const opts = avail.map((c,i) => `<option value="${state.couriers.indexOf(c)}">${c.name}</option>`).join('');
                contentHTML = sorted.map(m => {
                    const action = avail.length ? `<div style="display:flex;gap:5px; margin-top:5px"><select id="s_${m.id}" style="background:#333; color:#fff; border:none; padding:5px; border-radius:4px; width:100%">${opts}</select><button class="btn-green" onclick="acceptMission(${m.id}, document.getElementById('s_${m.id}').value)">GO</button></div>` : `<small style="color:var(--accent)">Aucun livreur dispo</small>`;
                    return `<div class="mission-grid-item"><div style="display:flex; justify-content:space-between"><strong>${m.name}</strong><span class="text-green">${m.reward}‚Ç¨</span></div><div><span class="badge badge-cap">üì¶ ${m.slots}</span> <span class="badge badge-time">‚è±Ô∏è ~${m.timeEst}m</span></div>${action}</div>`;
                }).join('');
            }
            document.getElementById('tabs-content').innerHTML = contentHTML;

            // Listes de personnel et v√©hicules.
            document.getElementById('couriers-list').innerHTML = state.couriers.map((c, i) => {
                const v = state.vehicles.find(veh => veh.id === c.vehicleId);
                return `<div class="card"><div><strong>${c.icon||'üë§'} ${c.name}</strong> <span style="color:var(--xp)">Lvl ${c.level}</span><br><small>${v ? v.icon + " " + v.name : '‚õî √Ä pied'}</small></div><button class="btn-blue" onclick="openAssignModal(${i})">üöó</button></div>`;
            }).join('');
            document.getElementById('garage-list').innerHTML = state.vehicles.map(v => {
                return `<div class="card"><div>${v.icon} <strong>${v.name}</strong> <small style="color:#888">${v.desc}</small></div><small>${v.assignedTo ? '‚úÖ Utilis√©' : 'üí§ Libre'}</small></div>`;
            }).join('');
            saveGame();
        }

        function updateClock() {
            const h = Math.floor(state.time/60); const m = Math.floor(state.time%60);
            document.getElementById('clock').innerText = `${h<10?'0'+h:h}:${m<10?'0'+m:m}`;
        }

        // Filtres pour les boutiques.
        function filterShop(cat, btn) { currentShopFilter = cat; document.querySelectorAll('#modal-shop .filter-btn').forEach(b => b.classList.remove('active')); if(btn) btn.classList.add('active'); renderShop(); }
        function filterHire(cat, btn) { currentHireFilter = cat; document.querySelectorAll('#modal-hire .filter-btn').forEach(b => b.classList.remove('active')); if(btn) btn.classList.add('active'); renderHire(); }
        
        // Rendu des grilles d'achat.
        function renderShop() {
            const filtered = currentShopFilter === 'all' ? VEHICLES : VEHICLES.filter(v => v.cat === currentShopFilter);
            document.getElementById('shop-grid').innerHTML = filtered.map(v => `<div class="shop-item ${v.cat === 'mythic' ? 'mythic-item' : (v.cat==='mil'?'mil-item':'')}" onclick="buyVehicle('${v.id}')"><span class="tag-price">${v.price} ‚Ç¨</span><div style="font-size:2em">${v.icon}</div><strong>${v.name}</strong><br><span class="badge badge-cap">üì¶ ${v.cap}</span> <span class="badge badge-time">üöÄ ${v.speed}</span><br><small style="color:#888">${v.desc}</small></div>`).join('');
        }
        function renderHire() {
            const filtered = RECRUITS.filter(r => r.cat === currentHireFilter);
            document.getElementById('hire-grid').innerHTML = filtered.map(r => `<div class="shop-item ${r.cat === 'legend' ? 'legend-item' : ''}" onclick="recruit('${r.id}')"><span class="tag-price">${r.price} ‚Ç¨</span><div style="font-size:2em">${r.icon}</div><strong>${r.name}</strong><br><span class="badge" style="color:#2ed573">x${r.spd} Vit</span> <span class="badge" style="color:#ffd32a">x${r.earn} Gain</span><br><small style="color:#888">${r.desc}</small></div>`).join('');
        }

        // --- ACTIONS & TRANSACTIONS ---
        function openLogModal() {
            document.getElementById('log-content').innerHTML = VERSION_LOG.map(entry => `<div class="log-entry"><div class="log-version">${entry.version} <small style="float:right; color:#888">${entry.date}</small></div><ul class="log-notes" style="list-style-type:none; padding:0; margin:0;">${entry.notes.map(note => `<li>${note}</li>`).join('')}</ul></div>`).join('');
            document.getElementById('modal-log').style.display = 'flex';
        }
        function buySkill(id) { const s = SKILLS_CATALOG.find(x => x.id === id); if(state.money >= s.price) { state.money -= s.price; state.skills[id] = true; closeModal('modal-skills'); notify(`Comp√©tence ${s.name} acquise !`, "success"); updateUI(); } else notify("Pas assez d'argent", "error"); }
        function buyGarageSlot() { const cost = (state.maxVehicles - 4) * 5000; if(state.money >= cost) { state.money -= cost; state.maxVehicles++; notify(`Garage agrandi ! (+1 Place)`, "success"); updateUI(); } else notify(`Besoin de ${cost}‚Ç¨`, "error"); }
        function buyVehicle(vId) { if(state.vehicles.length >= state.maxVehicles) return notify("Garage plein !", "error"); const v = VEHICLES.find(x => x.id === vId); if(state.money >= v.price) { state.money -= v.price; state.vehicles.push({ ...v, id: Date.now(), condition: 100, assignedTo: null }); closeModal('modal-shop'); notify(`${v.name} livr√©.`, "success"); updateUI(); } else notify("Fonds insuffisants", "error"); }
        function recruit(rId) { const r = RECRUITS.find(x => x.id === rId); if(state.money >= r.price) { state.money -= r.price; state.couriers.push({ id: Date.now(), name: r.name, level: 1, xp: 0, busy: false, vehicleId: null, spd: r.spd, earn: r.earn, icon: r.icon }); closeModal('modal-hire'); notify(`${r.name} recrut√© !`, "success"); updateUI(); } else notify("Pas assez d'argent", "error"); }
        function bankAction(type) { if(type === 'loan') { state.money += 5000; state.debt += 5000; notify("Emprunt√© 5000‚Ç¨", "info"); } if(type === 'repay') { if(state.money >= 1000 && state.debt > 0) { state.money -= 1000; state.debt -= 1000; notify("Rembours√© 1000‚Ç¨", "success"); } else notify("Impossible", "error"); } updateUI(); }
        
        // Co√ªts de fonctionnement.
        function payDailyCosts() { let m = (!state.skills.mechanic) ? state.vehicles.length * 50 : 0; if(state.skills.fuel_eco) m *= 0.7; let i = Math.floor(state.debt * 0.1); const s = state.couriers.length * 50; const total = m + i + s; state.money -= total; notify(`Co√ªts journaliers: -${Math.floor(total)}‚Ç¨`, "info"); }
        
        // Logique d'affectation v√©hicule <-> livreur.
        function assignVehicle(vId) { const c = state.couriers.find(x => x.selectingVehicle); const v = state.vehicles.find(x => x.id === vId); if(c.vehicleId) { const old = state.vehicles.find(x => x.id === c.vehicleId); if(old) old.assignedTo = null; } if(v.assignedTo) { const occupier = state.couriers.find(x => x.id === v.assignedTo); if(occupier) occupier.vehicleId = null; } c.vehicleId = v.id; v.assignedTo = c.id; delete c.selectingVehicle; closeModal('modal-assign'); updateUI(); }
        
        // Gestion des modales et utilitaires.
        function openHireModal() { renderHire(); document.getElementById('modal-hire').style.display = 'flex'; }
        function openSkillsModal() { document.getElementById('skills-grid').innerHTML = SKILLS_CATALOG.map(s => { const owned = state.skills[s.id]; return `<div class="shop-item" ${!owned ? `onclick="buySkill('${s.id}')"` : ''}><span class="tag-price ${owned?'tag-owned':''}">${owned ? 'ACQUIS' : s.price + '‚Ç¨'}</span><div style="font-size:2em">${s.icon}</div><strong>${s.name}</strong><p style="font-size:0.8em; color:#aaa">${s.desc}</p></div>`; }).join(''); document.getElementById('modal-skills').style.display = 'flex'; }
        function openModal(id) { if(id === 'modal-shop') renderShop(); document.getElementById(id).style.display = 'flex'; }
        function openAssignModal(idx) { state.couriers.forEach(c => delete c.selectingVehicle); state.couriers[idx].selectingVehicle = true; document.getElementById('assign-grid').innerHTML = state.vehicles.map(v => `<div class="shop-item" onclick="assignVehicle(${v.id})"><div style="font-size:1.5em">${v.icon}</div><strong>${v.name}</strong><br><small>${v.assignedTo?'‚ö†Ô∏è Occup√©':'‚úÖ Libre'}</small></div>`).join(''); document.getElementById('modal-assign').style.display = 'flex'; }
        function closeModal(id) { document.getElementById(id).style.display = 'none'; }
        
        // Syst√®me de notification (Toast).
        function notify(msg, type="info") { const area = document.getElementById('toast-area'); const t = document.createElement('div'); t.className = 'toast'; t.innerText = msg; if(type==='error') t.style.borderLeftColor = 'var(--accent)'; if(type==='success') t.style.borderLeftColor = 'var(--success)'; area.appendChild(t); setTimeout(() => t.remove(), 3000); }
        
        // Persistance.
        function hardReset() { if(confirm("Reset complet ?")) { localStorage.removeItem(SAVE_KEY); location.reload(); }}
        function saveGame() { localStorage.setItem(SAVE_KEY, JSON.stringify(state)); }
        function loadGame() { try { const d = localStorage.getItem(SAVE_KEY); if(d) state = {...state, ...JSON.parse(d)}; } catch(e){} }
        
        // Event Listener pour le bouton Turbo.
        const t = document.getElementById('turbo-zone');
        t.onmousedown = () => { state.speed = 10; document.body.style.filter = "saturate(1.2)"; };
        t.onmouseup = t.onmouseleave = () => { state.speed = 1; document.body.style.filter = "none"; };

    </script>
</body>
</html>